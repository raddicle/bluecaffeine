<?php

//App::import('Vendor', 'facebook/facebook');

class UsersController extends AppController {

    var $name = 'Users';
    var $helpers = array('Html', 'Form', 'Session', 'Facebook.Facebook');
    var $components = array('Session', 'Auth', 'Facebook.Connect');

    function beforeFilter() {
        parent::beforeFilter();
        $this->Auth->allow('login', 'logout', 'register', 'display', 'home');
    }

    function users() {
        
    }

    function login() {

        if (!empty($this->data)) {

            $username = $this->Auth->data['User']['username'];
            $find_by_email = $this->User->find('first', array(
                'conditions' => array('username' => $this->data['User']['username'])
                )
            );

            if (!empty($find_by_email)
                && $find_by_email['User']['password'] == $this->data['User']['password']) {
                $this->Auth->login($this->data);
                $this->Session->write('user', $find_by_email);
            } else {
                $this->Session->setFlash('Incorrect User/Password.');
                return $this->render("login");
            }
        } else {
            $facebookUser = $this->Connect->user();

            if (!empty($facebookUser)) {

                $existUser = $this->User->find('first', array(
                    'conditions' => array('username' => $facebookUser['email'])
                    )
                );

                if (empty($existUser)) {
                    $userDetails = $this->User->create();
                    $userDetails['User']['first_name'] = $facebookUser['first_name'];
                    $userDetails['User']['last_name'] = $facebookUser['last_name'];
                    $userDetails['User']['username'] = $facebookUser['email'];
                    $userDetails['User']['password'] = 'test';
                    $userDetails['User']['fbid'] = $facebookUser['id'];
                    $userDetails['User']['role'] = 'user';
                    $userDetails = $this->User->save($userDetails);
                }

                $this->Session->write('facebookUser', $facebookUser);
                $this->Session->write('user', $existUser);
                $this->Auth->login($existUser);
            }
        }
        $this->render("/Pages/home");
    }

    function logout() {

        $test = $this->Auth->logout();
        $this->Session->destroy();
        $this->render("/Pages/home");
    }

    function register() {
        if (!empty($this->data)) {
            if ($this->data['User']['password'] == $this->data['User']['confirm_password']) {
                $this->User->create();
                $userDetails = $this->User->save($this->data);
                if ($userDetails) {
                    $this->Session->write('user', $userDetails);
                    $this->Auth->login($this->data);
                    $this->redirect('/');
                }
            }
        }
    }

}

?>
